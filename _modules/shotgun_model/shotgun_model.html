



<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>shotgun_model.shotgun_model &mdash; tk-framework-shotgunutils v4.2.3 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="tk-framework-shotgunutils v4.2.3 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          
    <a href='http://developer.shotgunsoftware.com'>
    
        <img style='width: 191px;
                height: 60px; 
                margin: 2px;
                border-radius: 0px; 
                padding: 0px;' 
            src='../../_static/logo@2x.png'/>
    
    </a>
    

          
            <a href="../../index.html" class="icon icon-home"> tk-framework-shotgunutils
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          

        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
    
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../shotgun_model.html">Shotgun Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shotgun_data.html">Shotgun Asynchronous Data Retriever</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../task_manager.html">Background Task Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../settings.html">Shotgun Toolkit QT Settings Wrapper</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../shotgun_globals.html">Shotgun Globals Access</a></li>
</ul>

            
          
       
    <div style='margin-top: 50px;
                margin-left: 10px;
                margin-right: 10px;
                padding: 10px; 
                color: #b3b3b3; 
                font-size: 70%;
                border-radius: 3px;
                background-color: #444;
                line-height: 18px;
                '>    
    <style>
        a.custom_post_menu { display: inline; 
                             padding: 0px; 
                             text-decoration: underline; }
    </style>

    <b>tk-framework-shotgunutils</b> v4.2.3.<br>
    
        This documentation is part of the Shotgun Pipeline Toolkit.
    
    For more information, please visit
    <a class=custom_post_menu href='https://support.shotgunsoftware.com/home'>Shotgun Support</a>.
    The code associated with this documentation can be found 
    <a class=custom_post_menu href='https://github.com/shotgunsoftware/tk-framework-shotgunutils'>here</a>.

    </div>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">tk-framework-shotgunutils</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../index.html">Module code</a> &raquo;</li>
      
    <li>shotgun_model.shotgun_model</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for shotgun_model.shotgun_model</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2013 Shotgun Software Inc.</span>
<span class="c1">#</span>
<span class="c1"># CONFIDENTIAL AND PROPRIETARY</span>
<span class="c1">#</span>
<span class="c1"># This work is provided &quot;AS IS&quot; and subject to the Shotgun Pipeline Toolkit</span>
<span class="c1"># Source Code License included in this distribution package. See LICENSE.</span>
<span class="c1"># By accessing, using, copying or modifying this work you indicate your</span>
<span class="c1"># agreement to the Shotgun Pipeline Toolkit Source Code License. All rights</span>
<span class="c1"># not expressly granted therein are reserved by Shotgun Software Inc.</span>

<span class="kn">import</span> <span class="nn">tank</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">urlparse</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">weakref</span>

<span class="kn">from</span> <span class="nn">tank.platform.qt</span> <span class="kn">import</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span>
<span class="kn">from</span> <span class="nn">.shotgun_standard_item</span> <span class="kn">import</span> <span class="n">ShotgunStandardItem</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">get_sanitized_data</span><span class="p">,</span> <span class="n">get_sg_data</span><span class="p">,</span> <span class="n">sanitize_qt</span><span class="p">,</span> <span class="n">sanitize_for_qt_model</span>


<span class="k">class</span> <span class="nc">ShotgunModelError</span><span class="p">(</span><span class="n">tank</span><span class="o">.</span><span class="n">TankError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for all shotgun model exceptions&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">CacheReadVersionMismatch</span><span class="p">(</span><span class="n">ShotgunModelError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Indicates that a cache file is incompatible with this code&quot;&quot;&quot;</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="ShotgunModel"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel">[docs]</a><span class="k">class</span> <span class="nc">ShotgunModel</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QStandardItemModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A QT Model representing a Shotgun query.</span>

<span class="sd">    This class implements a standard  :class:`~PySide.QtCore.QAbstractItemModel`</span>
<span class="sd">    specialized to hold the contents of a particular Shotgun query. It is cached</span>
<span class="sd">    and refreshes its data asynchronously.</span>

<span class="sd">    In order to use this class, you normally subclass it and implement certain key data</span>
<span class="sd">    methods for setting up queries, customizing etc. Then you connect your class to</span>
<span class="sd">    a :class:`~PySide.QtGui.QAbstractItemView` of some sort which will display the result. If you need to do manipulations</span>
<span class="sd">    such as sorting or filtering on the data, connect a proxy model (typically :class:`~PySide.QtGui.QSortFilterProxyModel`)</span>
<span class="sd">    between your class and the view.</span>

<span class="sd">    :signal query_changed(): Gets emitted whenever the model&#39;s sg query is changed.</span>
<span class="sd">        When the query changes, the contents of the model is cleared and the</span>
<span class="sd">        loading of new data is initiated.</span>

<span class="sd">    :signal cache_loaded(): Emitted whenever the model loads cache data.</span>
<span class="sd">        This typically follows shortly after a query changed signal, if</span>
<span class="sd">        cache data is available.</span>

<span class="sd">    :signal data_refreshing(): Emitted whenever the model starts to refresh its</span>
<span class="sd">        shotgun data. This is emitted from :meth:`_refresh_data()`.  Useful</span>
<span class="sd">        signal if you want to present a loading indicator of some kind.</span>

<span class="sd">    :signal data_refreshed(bool): Emitted whenever the model has been updated with fresh</span>
<span class="sd">        shotgun data. The boolean indicates that a change in the model data has</span>
<span class="sd">        taken place as part of this process. If the refresh fails for some reason,</span>
<span class="sd">        this signal may not be emitted. The synchronous data refresh cycle starts</span>
<span class="sd">        with a call to :meth:`_refresh_data()` and normally ends with either a</span>
<span class="sd">        data_refreshed or a data_refresh_fail signal being emitted.</span>

<span class="sd">    :signal data_refresh_fail(): Emitted in the case the refresh fails for some reason,</span>
<span class="sd">        typically due to the absence of an internet connection. This signal could</span>
<span class="sd">        for example be used to drive a &quot;retry&quot; button of some kind. The str</span>
<span class="sd">        parameter carries an error message with details about why the</span>
<span class="sd">        refresh wasn&#39;t successful.</span>

<span class="sd">    :constant SG_DATA_ROLE: Custom model role that holds the</span>
<span class="sd">        associated value. See :ref:`sg-model-data-items`.</span>

<span class="sd">    :constant SG_ASSOCIATED_FIELD_ROLE: Custom model role that holds the</span>
<span class="sd">        shotgun data payload. See :ref:`sg-model-data-items`.  This role will also hold</span>
<span class="sd">        the field value for the Shotgun entity for any items that are created for additional</span>
<span class="sd">        columns.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># signal which gets emitted whenever the model&#39;s sg query is changed.</span>
    <span class="n">query_changed</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Signal</span><span class="p">()</span>

    <span class="c1"># signal which gets emitted whenever the model loads cache data.</span>
    <span class="n">cache_loaded</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Signal</span><span class="p">()</span>

    <span class="c1"># signal which gets emitted whenever the model starts to refresh its shotgun data.</span>
    <span class="n">data_refreshing</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Signal</span><span class="p">()</span>

    <span class="c1"># signal which gets emitted whenever the model has been updated with fresh shotgun data.</span>
    <span class="n">data_refreshed</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Signal</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

    <span class="c1"># signal which gets emitted in the case the refresh fails</span>
    <span class="n">data_refresh_fail</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Signal</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

    <span class="c1"># Custom model role that holds the shotgun data payload.</span>
    <span class="n">SG_DATA_ROLE</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">UserRole</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="c1"># Custom model role that holds the associated value.</span>
    <span class="n">SG_ASSOCIATED_FIELD_ROLE</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">UserRole</span> <span class="o">+</span> <span class="mi">3</span>

    <span class="c1"># internal constants - please do not access directly but instead use the helper</span>
    <span class="c1"># methods provided! We may change these constants without prior notice.</span>
    <span class="n">IS_SG_MODEL_ROLE</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">UserRole</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="c1"># magic number for IO streams</span>
    <span class="n">FILE_MAGIC_NUMBER</span> <span class="o">=</span> <span class="mh">0xDEADBEEF</span>
    <span class="c1"># version of binary format</span>
    <span class="n">FILE_VERSION</span> <span class="o">=</span> <span class="mi">22</span>

    <span class="c1"># header value for the first column</span>
    <span class="n">FIRST_COLUMN_HEADER</span> <span class="o">=</span> <span class="s2">&quot;Name&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">download_thumbs</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">schema_generation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bg_load_thumbs</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">bg_task_manager</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param parent: Parent object.</span>
<span class="sd">        :type parent: :class:`~PySide.QtGui.QWidget`</span>
<span class="sd">        :param download_thumbs: Boolean to indicate if this model should attempt</span>
<span class="sd">                                to download and process thumbnails for the downloaded data.</span>
<span class="sd">        :param schema_generation: Schema generation number. Advanced parameter. If your</span>
<span class="sd">                                  shotgun model contains logic in subclassed methods</span>
<span class="sd">                                  that modify the shotgun data prior to it being put into</span>
<span class="sd">                                  the cache system that the ShotgunModel maintains, you can</span>
<span class="sd">                                  use this option to ensure that different versions of the code</span>
<span class="sd">                                  access different caches. If you change your custom business logic</span>
<span class="sd">                                  around and update the generation number, both new and old</span>
<span class="sd">                                  versions of the code will work correctly against the cached data.</span>
<span class="sd">        :param bg_load_thumbs: If set to True, thumbnails will be loaded in the background.</span>
<span class="sd">        :param bg_task_manager:  Background task manager to use for any asynchronous work. If</span>
<span class="sd">                                 this is None then a task manager will be created as needed.</span>
<span class="sd">        :type bg_task_manager: :class:`~task_manager.BackgroundTaskManager`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">QtGui</span><span class="o">.</span><span class="n">QStandardItemModel</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_bundle</span> <span class="o">=</span> <span class="n">tank</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">current_bundle</span><span class="p">()</span>

        <span class="c1"># importing locally to not trip sphinx&#39;s imports.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shotgun_globals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bundle</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;shotgun_globals&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__schema_generation</span> <span class="o">=</span> <span class="n">schema_generation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__full_cache_path</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># is the model set up with a query?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__has_query</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># flag to indicate a full refresh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request_full_refresh</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># keep various references to all items that the model holds.</span>
        <span class="c1"># some of these data structures are to keep the GC</span>
        <span class="c1"># happy, others to hold alternative access methods to the data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__all_tree_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__entity_tree_data</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># keep track of info for thumbnail download/load</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__download_thumbs</span> <span class="o">=</span> <span class="n">download_thumbs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__bg_load_thumbs</span> <span class="o">=</span> <span class="n">bg_load_thumbs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__thumb_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># set up data retriever and start work:</span>
        <span class="n">shotgun_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bundle</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="s2">&quot;shotgun_data&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sg_data_retriever</span> <span class="o">=</span> <span class="n">shotgun_data</span><span class="o">.</span><span class="n">ShotgunDataRetriever</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">bg_task_manager</span><span class="o">=</span><span class="n">bg_task_manager</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sg_data_retriever</span><span class="o">.</span><span class="n">work_completed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_data_retriever_work_completed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sg_data_retriever</span><span class="o">.</span><span class="n">work_failure</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_data_retriever_work_failure</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__current_work_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sg_data_retriever</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1">########################################################################################</span>
    <span class="c1"># public methods</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">entity_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of entity ids that are part of this model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entity_tree_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

<div class="viewcode-block" id="ShotgunModel.destroy"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel.destroy">[docs]</a>    <span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call this method prior to destroying this object.</span>
<span class="sd">        This will ensure all worker threads etc are stopped.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__current_work_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__thumb_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># gracefully stop the data retriever:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sg_data_retriever</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__sg_data_retriever</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># block all signals before we clear the model otherwise downstream</span>
        <span class="c1"># proxy objects could cause crashes.</span>
        <span class="n">signals_blocked</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># clear all internal memory storage</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># reset the stage of signal blocking:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">blockSignals</span><span class="p">(</span><span class="n">signals_blocked</span><span class="p">)</span></div>

<div class="viewcode-block" id="ShotgunModel.item_from_entity"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel.item_from_entity">[docs]</a>    <span class="k">def</span> <span class="nf">item_from_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a :class:`~PySide.QtGui.QStandardItem` based on entity type and entity id</span>
<span class="sd">        Returns none if not found.</span>

<span class="sd">        :param entity_type: Shotgun entity type to look for</span>
<span class="sd">        :param entity_id: Shotgun entity id to look for</span>
<span class="sd">        :returns: :class:`~PySide.QtGui.QStandardItem` or None if not found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">entity_type</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entity_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">entity_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entity_tree_data</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entity_tree_data</span><span class="p">[</span><span class="n">entity_id</span><span class="p">]</span></div>

<div class="viewcode-block" id="ShotgunModel.index_from_entity"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel.index_from_entity">[docs]</a>    <span class="k">def</span> <span class="nf">index_from_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a QModelIndex based on entity type and entity id</span>
<span class="sd">        Returns none if not found.</span>

<span class="sd">        :param entity_type: Shotgun entity type to look for</span>
<span class="sd">        :param entity_id: Shotgun entity id to look for</span>
<span class="sd">        :returns: :class:`~PySide.QtCore.QModelIndex` or None if not found</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">item_from_entity</span><span class="p">(</span><span class="n">entity_type</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexFromItem</span><span class="p">(</span><span class="n">item</span><span class="p">)</span></div>

<div class="viewcode-block" id="ShotgunModel.get_filters"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel.get_filters">[docs]</a>    <span class="k">def</span> <span class="nf">get_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list of Shotgun filters representing the given item. This is useful if</span>
<span class="sd">        you are trying to determine how intermediate leaf nodes partition leaf node data.</span>

<span class="sd">        For example, if you have created a hierarchical model for a Shot listing::</span>

<span class="sd">            hierarchy: [sg_sequence, sg_status, code]</span>

<span class="sd">        The Shotgun model will group the data by sequence, then by status, then the leaf</span>
<span class="sd">        nodes will be the shot names. If you execute the get_filters() method on a sequence</span>
<span class="sd">        level tree node, it may return::</span>

<span class="sd">            [ [&#39;sg_sequence&#39;, &#39;is&#39;, {&#39;type&#39;: &#39;Sequence&#39;, &#39;id&#39;: 123, &#39;name&#39;: &#39;foo&#39;}] ]</span>

<span class="sd">        If you execute the get_filters() on a status node in the tree, it may return::</span>

<span class="sd">            [</span>
<span class="sd">              [&#39;sg_sequence&#39;, &#39;is&#39;, {&#39;type&#39;: &#39;Sequence&#39;, &#39;id&#39;: 123, &#39;name&#39;: &#39;foo&#39;}],</span>
<span class="sd">              [&#39;sg_status&#39;, &#39;is&#39;, &#39;ip&#39;]</span>
<span class="sd">            ]</span>

<span class="sd">        :param item: One of the :class:`~PySide.QtGui.QStandardItem` s that are</span>
<span class="sd">                     associated with this model.</span>
<span class="sd">        :returns: standard shotgun filter list to represent that item</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># prime filters with our base query</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">)</span>

        <span class="c1"># now walk up the tree and get all fields</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">while</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">field_data</span> <span class="o">=</span> <span class="n">get_sanitized_data</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">SG_ASSOCIATED_FIELD_ROLE</span><span class="p">)</span>
            <span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span> <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="s2">&quot;is&quot;</span><span class="p">,</span> <span class="n">field_data</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">filters</span></div>

<div class="viewcode-block" id="ShotgunModel.get_entity_type"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel.get_entity_type">[docs]</a>    <span class="k">def</span> <span class="nf">get_entity_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the Shotgun Entity type associated with this model.</span>

<span class="sd">        :returns: Shotgun entity type string (e.g. &#39;Shot&#39;, &#39;Asset&#39; etc).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entity_type</span></div>

<div class="viewcode-block" id="ShotgunModel.get_additional_column_fields"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel.get_additional_column_fields">[docs]</a>    <span class="k">def</span> <span class="nf">get_additional_column_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the fields for additional columns and their associated column in the model.</span>

<span class="sd">        :returns: A list of dictionaries with the following keys:</span>
<span class="sd">            &quot;field&quot;: the requested additional field for the column</span>
<span class="sd">            &quot;column_idx&quot;: the column number in the model associated with the additional field</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># column is one greater than the index because of the default initial column</span>
        <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;column_idx&quot;</span><span class="p">:</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">field</span><span class="p">}</span> <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__column_fields</span><span class="p">)]</span></div>

<div class="viewcode-block" id="ShotgunModel.hard_refresh"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel.hard_refresh">[docs]</a>    <span class="k">def</span> <span class="nf">hard_refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears any caches on disk, then refreshes the data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__has_query</span><span class="p">:</span>
            <span class="c1"># no query in this model yet</span>
            <span class="k">return</span>

        <span class="c1"># when data arrives, force full rebuild</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request_full_refresh</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c1"># delete cache file</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__full_cache_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__full_cache_path</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__full_cache_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;Removed cache file &#39;</span><span class="si">%s</span><span class="s2">&#39; from disk.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__full_cache_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log_warning</span><span class="p">(</span><span class="s2">&quot;clear_caches method could not remove cache file &#39;</span><span class="si">%s</span><span class="s2">&#39; &quot;</span>
                                   <span class="s2">&quot;from disk. Details: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__full_cache_path</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
        <span class="c1"># refresh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refresh_data</span><span class="p">()</span></div>

<div class="viewcode-block" id="ShotgunModel.is_data_cached"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel.is_data_cached">[docs]</a>    <span class="k">def</span> <span class="nf">is_data_cached</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine if the model has any cached data</span>

<span class="sd">        :returns:    True if cached data exists for the model, otherwise False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__full_cache_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__full_cache_path</span><span class="p">)</span></div>

    <span class="c1">########################################################################################</span>
    <span class="c1"># methods overridden from the base class.</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes all items (including header items) from the model and</span>
<span class="sd">        sets the number of rows and columns to zero.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Advertise that the model is about to completely cleared. This is super important because proxy</span>
        <span class="c1"># models usually cache data like indices and these are about to get updated potentially thousands</span>
        <span class="c1"># of times while the tree is being destroyed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beginResetModel</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># note! We are reimplementing this explicitly because the default implementation</span>
            <span class="c1"># results in memory issues - similar to reset(), scenarios where objects are constructed</span>
            <span class="c1"># in python (e.g. qstandarditems) and then handed over to a model and then subsequently</span>
            <span class="c1"># cleared and deallocated by QT itself (on the C++ side) often results in dangling pointers</span>
            <span class="c1"># across the pyside/QT boundary, ultimately resulting in crashes or instability.</span>

            <span class="c1"># clear thumbnail download lookup so we don&#39;t process any more results:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__thumb_map</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># we are not looking for any data from the async processor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__current_work_id</span> <span class="o">=</span> <span class="bp">None</span>

            <span class="c1"># ask async data retriever to clear its queue of queries and thumb downloads</span>
            <span class="c1"># note that there may still be requests actually running</span>
            <span class="c1"># - these are not cancelled</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sg_data_retriever</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__sg_data_retriever</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="c1"># model data in alt format</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__entity_tree_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># pyside will crash unless we actively hold a reference</span>
            <span class="c1"># to all items that we create.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__all_tree_items</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># lastly, remove all data in the underlying internal data storage</span>
            <span class="c1"># note that we don&#39;t cannot clear() here since that causing</span>
            <span class="c1"># crashing in various environments. Also note that we need to do</span>
            <span class="c1"># in a depth-first manner to ensure that there are no</span>
            <span class="c1"># cyclic parent/child dependency cycles, which will cause</span>
            <span class="c1"># a crash in some versions of shiboken</span>
            <span class="c1"># (see https://bugreports.qt-project.org/browse/PYSIDE-158 )</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__do_depth_first_tree_deletion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">invisibleRootItem</span><span class="p">())</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Advertise that we&#39;re done resetting.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endResetModel</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reimplements QAbstractItemModel:reset() by &#39;sealing it&#39; so that</span>
<span class="sd">        it cannot be executed by calling code easily. This is because the reset method</span>
<span class="sd">        often results in crashes and instability because of how PySide/QT manages memory.</span>

<span class="sd">        For more information, see the clear() method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;The QAbstractItemModel::reset method has been explicitly been disabled &quot;</span>
                                  <span class="s2">&quot;because memory is not correctly freed up across C++/Python when &quot;</span>
                                  <span class="s2">&quot;executed, sometimes resulting in runtime instability. For an &quot;</span>
                                  <span class="s2">&quot;semi-equivalent method, use clear(), however keep in mind that &quot;</span>
                                  <span class="s2">&quot;this method will not emit the standard before/after reset signals. &quot;</span>
                                  <span class="s2">&quot;It is possible that this method may be implemented in later versions &quot;</span>
                                  <span class="s2">&quot;of the framework. For more information, please &quot;</span>
                                  <span class="s2">&quot;email support@shotgunsoftware.com.&quot;</span> <span class="p">)</span>


    <span class="c1">########################################################################################</span>
    <span class="c1"># protected methods not meant to be subclassed but meant to be called by subclasses</span>

<div class="viewcode-block" id="ShotgunModel._load_data"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel._load_data">[docs]</a>    <span class="k">def</span> <span class="nf">_load_data</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">columns</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">additional_filter_presets</span><span class="o">=</span><span class="bp">None</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is the main method to use to configure the model. You basically</span>
<span class="sd">        pass a specific find query to the model and it will start tracking</span>
<span class="sd">        this particular set of filter and hierarchy parameters.</span>

<span class="sd">        Any existing data in contained in the model will be cleared.</span>

<span class="sd">        This method will not call the Shotgun API. If cached data is available,</span>
<span class="sd">        this will be immediately loaded (this operation is very fast even for</span>
<span class="sd">        substantial amounts of data).</span>

<span class="sd">        If you want to refresh the data contained in the model (which you typically</span>
<span class="sd">        want to), call the :meth:`_refresh_data()` method.</span>

<span class="sd">        :param entity_type:               Shotgun entity type to download</span>
<span class="sd">        :param filters:                   List of Shotgun filters. Standard Shotgun syntax. Passing None instead</span>
<span class="sd">                                          of a list of filters indicates that no shotgun data should be retrieved</span>
<span class="sd">                                          and no API calls will be made.</span>
<span class="sd">        :param hierarchy:                 List of grouping fields. These should be names of Shotgun</span>
<span class="sd">                                          fields. If you for example want to create a list of items,</span>
<span class="sd">                                          the value ``[&quot;code&quot;]`` will be suitable. This will generate a data</span>
<span class="sd">                                          model which is flat and where each item&#39;s default name is the</span>
<span class="sd">                                          Shotgun name field. If you want to generate a tree where assets</span>
<span class="sd">                                          are broken down by asset type, you could instead specify</span>
<span class="sd">                                          ``[&quot;sg_asset_type&quot;, &quot;code&quot;]``.</span>
<span class="sd">        :param fields:                    Fields to retrieve from Shotgun (in addition to the ones specified</span>
<span class="sd">                                          in the hierarchy parameter). Standard Shotgun API syntax. If you</span>
<span class="sd">                                          specify None for this parameter, Shotgun will not be called when</span>
<span class="sd">                                          the _refresh_data() method is being executed.</span>
<span class="sd">        :param order:                     Order clause for the Shotgun data. Standard Shotgun API syntax.</span>
<span class="sd">                                          Note that this is an advanced parameter which is meant to be used</span>
<span class="sd">                                          in subclassing only. The model itself will be ordered by its</span>
<span class="sd">                                          default display name, and if any other type of ordering is desirable,</span>
<span class="sd">                                          use for example a QProxyModel to handle this. However, knowing in which</span>
<span class="sd">                                          order results will arrive from Shotgun can be beneficial if you are doing</span>
<span class="sd">                                          grouping, deferred loading and aggregation of data as part of your</span>
<span class="sd">                                          subclassed implementation, typically via the :meth:`_before_data_processing()` method.</span>
<span class="sd">        :param seed:                      Advanced parameter. With each shotgun query being cached on disk, the model</span>
<span class="sd">                                          generates a cache seed which it is using to store data on disk. Since the cache</span>
<span class="sd">                                          data on disk is a reflection of a particular shotgun query, this seed is typically</span>
<span class="sd">                                          generated from the various query and field parameters passed to this method. However,</span>
<span class="sd">                                          in some cases when you are doing advanced subclassing, for example when you are culling</span>
<span class="sd">                                          out data based on some external state, the model state does not solely depend on the</span>
<span class="sd">                                          shotgun query parameters. It may also depend on some external factors. In this case,</span>
<span class="sd">                                          the cache seed should also be influenced by those parameters and you can pass</span>
<span class="sd">                                          an external string via this parameter which will be added to the seed.</span>
<span class="sd">        :param limit:                     Limit the number of results returned from Shotgun. In conjunction with the order</span>
<span class="sd">                                          parameter, this can be used to effectively cap the data set that the model</span>
<span class="sd">                                          is handling, allowing a user to for example show the twenty most recent notes or</span>
<span class="sd">                                          similar.</span>
<span class="sd">        :param columns:                   If columns is specified, then any leaf row in the model will have columns created where</span>
<span class="sd">                                          each column in the row contains the value for the corresponding field from columns. This means</span>
<span class="sd">                                          that the data from the loaded entity will be available field by field. Subclasses can modify</span>
<span class="sd">                                          this behavior by overriding _get_additional_columns.</span>
<span class="sd">        :param additional_filter_presets: List of Shotgun filter presets to apply, e.g.</span>
<span class="sd">                                          ``[{&quot;preset_name&quot;:&quot;LATEST&quot;,&quot;latest_by&quot;:&quot;BY_PIPELINE_STEP_NUMBER_AND_ENTITIES_CREATED_AT&quot;}]``</span>

<span class="sd">        :returns:                         True if cached data was loaded, False if not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># we are changing the query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_changed</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

        <span class="c1"># clear out old data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__has_query</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__entity_type</span> <span class="o">=</span> <span class="n">entity_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span> <span class="o">=</span> <span class="n">filters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fields</span> <span class="o">=</span> <span class="n">fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__order</span> <span class="o">=</span> <span class="n">order</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__hierarchy</span> <span class="o">=</span> <span class="n">hierarchy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__column_fields</span> <span class="o">=</span> <span class="n">columns</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__limit</span> <span class="o">=</span> <span class="n">limit</span> <span class="ow">or</span> <span class="mi">0</span> <span class="c1"># 0 means get all matches</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__additional_filter_presets</span> <span class="o">=</span> <span class="n">additional_filter_presets</span>

        <span class="c1"># when we cache the data associated with this model, create</span>
        <span class="c1"># the file name and path based on several parameters.</span>
        <span class="c1"># the path will be on the form CACHE_LOCATION/cached_sg_queries/EntityType/params_hash/filter_hash</span>
        <span class="c1">#</span>
        <span class="c1"># params_hash is an md5 hash representing all parameters going into a particular</span>
        <span class="c1"># query setup and filters_hash is an md5 hash of the filter conditions.</span>
        <span class="c1">#</span>
        <span class="c1"># the reason these are split up is because the params tend to be constant and</span>
        <span class="c1"># the filters keep varying depending on user input.</span>
        <span class="c1">#</span>
        <span class="c1"># some comment regarding the fields that make up the hash</span>
        <span class="c1">#</span>
        <span class="c1"># fields, order, hierarchy are all coming from Shotgun</span>
        <span class="c1"># and are used to uniquely identify the cache file. Typically,</span>
        <span class="c1"># code using the shotgun model will keep these fields constant</span>
        <span class="c1"># while varying filters. With the filters hashed separately,</span>
        <span class="c1"># this typically generates a folder structure where there is one</span>
        <span class="c1"># top level folder containing a series of cache files</span>
        <span class="c1"># all for different filters.</span>
        <span class="c1">#</span>
        <span class="c1"># the schema generation is used for advanced implementations</span>
        <span class="c1"># See constructor docstring for details.</span>
        <span class="c1">#</span>
        <span class="c1"># bg_load_thumbs is hashed so that the system can cache</span>
        <span class="c1"># thumb and non-thumb caches independently. This is because</span>
        <span class="c1"># as soon as you start caching thumbnails, qpixmap will be used</span>
        <span class="c1"># internally by the serialization and this means that you get</span>
        <span class="c1"># warnings if you try to use those caches in threads. By keeping</span>
        <span class="c1"># caches separate, there is no risk that a thumb cache &#39;pollutes&#39;</span>
        <span class="c1"># a non-thumb cache.</span>
        <span class="c1">#</span>
        <span class="c1"># now hash up the rest of the parameters and make that the filename</span>
        <span class="n">params_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
        <span class="n">params_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__schema_generation</span><span class="p">))</span>
        <span class="n">params_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__bg_load_thumbs</span><span class="p">))</span>
        <span class="n">params_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__fields</span><span class="p">))</span>
        <span class="n">params_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__order</span><span class="p">))</span>
        <span class="n">params_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__hierarchy</span><span class="p">))</span>
        <span class="c1"># If this value changes over time (like between Qt4 and Qt5), we need to</span>
        <span class="c1"># assume our previous user roles are invalid since Qt might have taken over</span>
        <span class="c1"># it. If role&#39;s value is 32, don&#39;t add it to the hash so we don&#39;t</span>
        <span class="c1"># invalidate PySide/PyQt4 caches.</span>
        <span class="k">if</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">UserRole</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">:</span>
            <span class="n">params_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">UserRole</span><span class="p">))</span>

        <span class="c1"># now hash up the filter parameters and the seed - these are dynamic</span>
        <span class="c1"># values that tend to change and be data driven, so they are handled</span>
        <span class="c1"># on a different level in the path</span>
        <span class="n">filter_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
        <span class="n">filter_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">))</span>
        <span class="n">filter_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__additional_filter_presets</span><span class="p">))</span>
        <span class="n">params_hash</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">seed</span><span class="p">))</span>

        <span class="c1"># organize files on disk based on entity type and then filter hash</span>
        <span class="c1"># keep extension names etc short in order to stay away from MAX_PATH</span>
        <span class="c1"># on windows.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__full_cache_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_bundle</span><span class="o">.</span><span class="n">cache_location</span><span class="p">,</span>
                                              <span class="s2">&quot;sg&quot;</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">__entity_type</span><span class="p">,</span>
                                              <span class="n">params_hash</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(),</span>
                                              <span class="n">filter_hash</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__full_cache_path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">250</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log_warning</span><span class="p">(</span><span class="s2">&quot;Cache file path may be affected by windows MAX_PATH limitation.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;Model Reset for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;Entity type: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__entity_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;Cache path: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__full_cache_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;Filters: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;Hierarchy: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hierarchy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;Fields: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fields</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;Order: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__order</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;Columns: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__column_fields</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;Filter Presets: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__additional_filter_presets</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;First population pass: Calling _load_external_data()&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_external_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;External data population done.&quot;</span><span class="p">)</span>

        <span class="n">loaded_cache_data</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__full_cache_path</span><span class="p">):</span>
            <span class="c1"># first see if we need to load in any overlay data from deriving classes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;Now loading cached data </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__full_cache_path</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">time_before</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="n">num_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__load_from_disk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__full_cache_path</span><span class="p">)</span>
                <span class="n">time_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time_before</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;...loading complete! </span><span class="si">%s</span><span class="s2"> items loaded in </span><span class="si">%4f</span><span class="s2">s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">num_items</span><span class="p">,</span> <span class="n">time_diff</span><span class="p">))</span>
                <span class="n">loaded_cache_data</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cache_loaded</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t load cache data from disk. Will proceed with &quot;</span>
                                <span class="s2">&quot;full SG load. Error reported: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

        <span class="c1"># set our headers</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">FIRST_COLUMN_HEADER</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_additional_column_headers</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__entity_type</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__column_fields</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setHorizontalHeaderLabels</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">loaded_cache_data</span></div>

<div class="viewcode-block" id="ShotgunModel._refresh_data"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel._refresh_data">[docs]</a>    <span class="k">def</span> <span class="nf">_refresh_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rebuilds the data in the model to ensure it is up to date.</span>
<span class="sd">        This call is asynchronous and will return instantly.</span>
<span class="sd">        The update will be applied whenever the data from Shotgun is returned.</span>

<span class="sd">        If the model is empty (no cached data) no data will be shown at first</span>
<span class="sd">        while the model fetches data from Shotgun.</span>

<span class="sd">        As soon as a local cache exists, data is shown straight away and the</span>
<span class="sd">        shotgun update happens silently in the background.</span>

<span class="sd">        If data has been added, this will be injected into the existing structure.</span>
<span class="sd">        In this case, the rest of the model is intact, meaning that also selections</span>
<span class="sd">        and other view related states are unaffected.</span>

<span class="sd">        If data has been modified or deleted, a full rebuild is issued, meaning that</span>
<span class="sd">        all existing items from the model are removed. This does affect view related</span>
<span class="sd">        states such as selection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sg_data_retriever</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TankError</span><span class="p">(</span><span class="s2">&quot;Data retriever is not available!&quot;</span><span class="p">)</span>

        <span class="c1"># Stop any queued work that hasn&#39;t completed yet.  Note that we intentionally only stop the</span>
        <span class="c1"># find query and not the thumbnail cache/download.  This is because the thumbnails returned</span>
        <span class="c1"># are likely to still be valid for the current data in the model and if they are stopped then</span>
        <span class="c1"># the pattern &#39;create model-&gt;load cached-&gt;refresh from sg&#39; would result in empty icons being</span>
        <span class="c1"># presented to the user until the shotgun query has completed!</span>
        <span class="c1">#</span>
        <span class="c1"># This may result in unnecessary thumbnail downloads from Shotgun but in all likelihood, the</span>
        <span class="c1"># thumbnails are going to be the same before and after the refresh and any additional overhead</span>
        <span class="c1"># should be weighed against a cleaner user experience</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_work_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__sg_data_retriever</span><span class="o">.</span><span class="n">stop_work</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__current_work_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__current_work_id</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># emit that the data is refreshing.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_refreshing</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># filters is None indicates that no data is desired.</span>
            <span class="c1"># do not issue the sg request but pass straight to the callback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__on_sg_data_arrived</span><span class="p">([])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># get data from shotgun - list/set cast to ensure unique fields</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hierarchy</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fields</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__column_fields</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__download_thumbs</span><span class="p">:</span>
                <span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">fields</span><span class="p">))</span>

            <span class="n">find_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="n">limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__limit</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># We only want to include the filter presets kwarg if it was explicitly asked</span>
            <span class="c1"># for. The reason for this is that it&#39;s a Shotgun 7.0 feature server side, and</span>
            <span class="c1"># we don&#39;t want to break backwards compatibility with older versions of Shotgun.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__additional_filter_presets</span><span class="p">:</span>
                <span class="n">find_kwargs</span><span class="p">[</span><span class="s2">&quot;additional_filter_presets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__additional_filter_presets</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">__current_work_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sg_data_retriever</span><span class="o">.</span><span class="n">execute_find</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__entity_type</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__filters</span><span class="p">,</span>
                <span class="n">fields</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__order</span><span class="p">,</span>
                <span class="o">**</span><span class="n">find_kwargs</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="ShotgunModel._request_thumbnail_download"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel._request_thumbnail_download">[docs]</a>    <span class="k">def</span> <span class="nf">_request_thumbnail_download</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">,</span> <span class="n">entity_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Request that a thumbnail is downloaded for an item. If a thumbnail is successfully</span>
<span class="sd">        retrieved, either from disk (cached) or via shotgun, the method _populate_thumbnail()</span>
<span class="sd">        will be called. If you want to control exactly how your shotgun thumbnail is</span>
<span class="sd">        to appear in the UI, you can subclass this method. For example, you can subclass</span>
<span class="sd">        this method and perform image composition prior to the image being added to</span>
<span class="sd">        the item object.</span>

<span class="sd">        .. note:: This is an advanced method which you can use if you want to load thumbnail</span>
<span class="sd">            data other than the standard &#39;image&#39; field. If that&#39;s what you need, simply make</span>
<span class="sd">            sure that you set the download_thumbs parameter to true when you create the model</span>
<span class="sd">            and standard thumbnails will be automatically downloaded. This method is either used</span>
<span class="sd">            for linked thumb fields or if you want to download thumbnails for external model data</span>
<span class="sd">            that doesn&#39;t come from Shotgun.</span>

<span class="sd">        :param item: :class:`~PySide.QtGui.QStandardItem` which belongs to this model</span>
<span class="sd">        :param field: Shotgun field where the thumbnail is stored. This is typically ``image`` but</span>
<span class="sd">                      can also for example be ``sg_sequence.Sequence.image``.</span>
<span class="sd">        :param url: thumbnail url</span>
<span class="sd">        :param entity_type: Shotgun entity type</span>
<span class="sd">        :param entity_id: Shotgun entity id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># nothing to download. bad input. gracefully ignore this request.</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sg_data_retriever</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TankError</span><span class="p">(</span><span class="s2">&quot;Data retriever is not available!&quot;</span><span class="p">)</span>

        <span class="n">uid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sg_data_retriever</span><span class="o">.</span><span class="n">request_thumbnail</span><span class="p">(</span><span class="n">url</span><span class="p">,</span>
                                                         <span class="n">entity_type</span><span class="p">,</span>
                                                         <span class="n">entity_id</span><span class="p">,</span>
                                                         <span class="n">field</span><span class="p">,</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">__bg_load_thumbs</span><span class="p">)</span>

        <span class="c1"># keep tabs of this and call out later - note that we use a weakref to allow</span>
        <span class="c1"># the model item to be gc&#39;d if it&#39;s removed from the model before the thumb</span>
        <span class="c1"># request completes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__thumb_map</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;item_ref&quot;</span><span class="p">:</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">item</span><span class="p">),</span> <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">field</span> <span class="p">}</span></div>

    <span class="c1">########################################################################################</span>
    <span class="c1"># methods to be implemented by subclasses</span>

<div class="viewcode-block" id="ShotgunModel._populate_item"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel._populate_item">[docs]</a>    <span class="k">def</span> <span class="nf">_populate_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">sg_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Whenever an item is downloaded from Shotgun, this method is called. It allows subclasses to intercept</span>
<span class="sd">        the construction of a :class:`~PySide.QtGui.QStandardItem` and add additional metadata or make other changes</span>
<span class="sd">        that may be useful. Nothing needs to be returned.</span>

<span class="sd">        This method is called before the item is added into the model tree. At the point when</span>
<span class="sd">        the item is added into the tree, various signals will fire, informing views and proxy</span>
<span class="sd">        models that a new item has been added. This methods allows a subclassing object to</span>
<span class="sd">        add custom data prior to this.</span>

<span class="sd">        .. note:: When an item is fetched from the cache, this method is *not* called, it will</span>
<span class="sd">            only be called when shotgun data initially arrives from a Shotgun API query.</span>

<span class="sd">        .. note:: This is typically subclassed if you retrieve additional fields alongside the standard &quot;name&quot; field</span>
<span class="sd">            and you want to put those into various custom data roles. These custom fields on the item</span>
<span class="sd">            can later on be picked up by custom (delegate) rendering code in the view.</span>

<span class="sd">        :param item: :class:`~PySide.QtGui.QStandardItem` that is about to be added to the model. This has been primed</span>
<span class="sd">                     with the standard settings that the ShotgunModel handles.</span>
<span class="sd">        :param sg_data: Shotgun data dictionary that was received from Shotgun given the fields</span>
<span class="sd">                        and other settings specified in _load_data()</span>
<span class="sd">        &quot;&quot;&quot;</span></div>
        <span class="c1"># default implementation does nothing</span>

<div class="viewcode-block" id="ShotgunModel._populate_default_thumbnail"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel._populate_default_thumbnail">[docs]</a>    <span class="k">def</span> <span class="nf">_populate_default_thumbnail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called whenever an item is constructed and needs to be associated with a default thumbnail.</span>
<span class="sd">        In the current implementation, thumbnails are not cached in the same way as the rest of</span>
<span class="sd">        the model data, meaning that this method is executed each time an item is constructed,</span>
<span class="sd">        regardless of if it came from an asynchronous shotgun query or a cache fetch.</span>

<span class="sd">        The purpose of this method is that you can subclass it if you want to ensure that items</span>
<span class="sd">        have an associated thumbnail directly when they are first created.</span>

<span class="sd">        Later on in the data load cycle, if the model was instantiated with the</span>
<span class="sd">        `download_thumbs` parameter set to True,</span>
<span class="sd">        the standard Shotgun ``image`` field thumbnail will be automatically downloaded for all items (or</span>
<span class="sd">        picked up from local cache if possible). When these real thumbnails arrive, the</span>
<span class="sd">        meth:`_populate_thumbnail()` method will be called.</span>

<span class="sd">        :param item: :class:`~PySide.QtGui.QStandardItem` that is about to be added to the model.</span>
<span class="sd">            This has been primed with the standard settings that the ShotgunModel handles.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>
        <span class="c1"># the default implementation does nothing</span>

<div class="viewcode-block" id="ShotgunModel._finalize_item"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel._finalize_item">[docs]</a>    <span class="k">def</span> <span class="nf">_finalize_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called whenever an item is fully constructed, either because a shotgun query returned it</span>
<span class="sd">        or because it was loaded as part of a cache load from disk.</span>

<span class="sd">        .. note:: You can subclass this if you want to run post processing on</span>
<span class="sd">            the data as it is arriving. For example, if you are showing a list of</span>
<span class="sd">            task statuses in a filter view, you may want to remember which</span>
<span class="sd">            statuses a user had checked and unchecked the last time he was running</span>
<span class="sd">            the tool. By subclassing this UI you can easily apply those settings</span>
<span class="sd">            before items appear in the UI.</span>

<span class="sd">        :param item: :class:`~PySide.QtGui.QStandardItem` that is about to be added to the model.</span>
<span class="sd">            This has been primed with the standard settings that the ShotgunModel handles.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>
        <span class="c1"># the default implementation does nothing</span>

<div class="viewcode-block" id="ShotgunModel._set_tooltip"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel._set_tooltip">[docs]</a>    <span class="k">def</span> <span class="nf">_set_tooltip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">sg_item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when an item is created.</span>

<span class="sd">        .. note:: You can subclass this if you want to set your own tooltip for the model item. By</span>
<span class="sd">            default, the SG_ASSOCIATED_FIELD_ROLE data is retrieved and the field name is used to</span>
<span class="sd">            determine which field to pick tooltip information from.</span>

<span class="sd">            For example,</span>

<span class="sd">            .. code-block:: python</span>

<span class="sd">               {</span>
<span class="sd">                   &quot;type&quot;: &quot;Task&quot;,</span>
<span class="sd">                   &quot;entity&quot;: {                       # (1) Tooltip becomes &quot;Asset &#39;Alice&#39;&quot;</span>
<span class="sd">                       &quot;sg_asset_type&quot;: &quot;Character&quot;, # (2) Tooltip becomes &quot;Asset Type &#39;Character&#39;&quot;</span>
<span class="sd">                       &quot;type&quot;: &quot;Asset&quot;,</span>
<span class="sd">                       &quot;code&quot;: &quot;Alice&quot;</span>
<span class="sd">                   },</span>
<span class="sd">                   &quot;content&quot;: &quot;Art&quot;                  # (3) Tooltip becomes &quot;Task &#39;Art&#39;&quot;</span>
<span class="sd">               }</span>

<span class="sd">            1) If the field is an entity (e.g. entity), then the display name of that entity&#39;s type</span>
<span class="sd">            will be used.</span>

<span class="sd">            2) If the field is part of a sub-entity (e.g entity.Asset.sg_asset_type), the display</span>
<span class="sd">            name of the sub-entity&#39;s type followed by a space and the sub-entity&#39;s field display name</span>
<span class="sd">            will be used.</span>

<span class="sd">            3) If the field is part of an entity and not an entity field(e.g. content), the display</span>
<span class="sd">            name of the entity&#39;s type will be used.</span>

<span class="sd">            In all cases, the string ends with the quoted name of the ShotgunStandardItem.</span>

<span class="sd">        :param item: Shotgun model item that requires a tooltip.</span>
<span class="sd">        :param sg_item: Dictionary of the entity associated with the Shotgun model item.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SG_ASSOCIATED_FIELD_ROLE</span><span class="p">)</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sg_item</span><span class="p">[</span><span class="n">field</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;type&quot;</span> <span class="ow">in</span> <span class="n">sg_item</span><span class="p">[</span><span class="n">field</span><span class="p">]:</span>
            <span class="c1"># This is scenario 1 described above.</span>
            <span class="n">item</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_shotgun_globals</span><span class="o">.</span><span class="n">get_type_display_name</span><span class="p">(</span><span class="n">sg_item</span><span class="p">[</span><span class="n">field</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]),</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">field</span><span class="p">:</span>
            <span class="c1"># This is scenario 2 described above. We only want to get the last entity and field.</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">sub_entity_type</span><span class="p">,</span> <span class="n">sub_entity_field_name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">item</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2"> &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_shotgun_globals</span><span class="o">.</span><span class="n">get_type_display_name</span><span class="p">(</span><span class="n">sub_entity_type</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_shotgun_globals</span><span class="o">.</span><span class="n">get_field_display_name</span><span class="p">(</span><span class="n">sub_entity_type</span><span class="p">,</span> <span class="n">sub_entity_field_name</span><span class="p">),</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This is scenario 3 described above.</span>
            <span class="n">item</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_shotgun_globals</span><span class="o">.</span><span class="n">get_type_display_name</span><span class="p">(</span><span class="n">sg_item</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]),</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="ShotgunModel._populate_thumbnail"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel._populate_thumbnail">[docs]</a>    <span class="k">def</span> <span class="nf">_populate_thumbnail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called whenever the real thumbnail for an item exists on disk. The following</span>
<span class="sd">        execution sequence typically happens:</span>

<span class="sd">        - :class:`~PySide.QtGui.QStandardItem` is created, either through a cache load from disk or</span>
<span class="sd">          from a payload coming from the Shotgun API.</span>
<span class="sd">        - After the item has been set up with its associated Shotgun data,</span>
<span class="sd">          :meth:`_populate_default_thumbnail()` is called, allowing client code to set</span>
<span class="sd">          up a default thumbnail that will be shown while potential real thumbnail</span>
<span class="sd">          data is being loaded.</span>
<span class="sd">        - The model will now start looking for the real thumbail.</span>
<span class="sd">        - If the thumbnail is already cached on disk, :meth:`_populate_thumbnail()` is called very soon.</span>
<span class="sd">        - If there isn&#39;t a thumbnail associated, :meth:`_populate_thumbnail()` will not be called.</span>
<span class="sd">        - If there isn&#39;t a thumbnail cached, the model will asynchronously download</span>
<span class="sd">          the thumbnail from Shotgun and then (after some time) call :meth:`_populate_thumbnail()`.</span>

<span class="sd">        This method will be called for standard thumbnails if the model has been</span>
<span class="sd">        instantiated with the download_thumbs flag set to be true. It will be called for</span>
<span class="sd">        items which are associated with shotgun entities (in a tree data layout, this is typically</span>
<span class="sd">        leaf nodes). It will also be called once the data requested via _request_thumbnail_download()</span>
<span class="sd">        arrives.</span>

<span class="sd">        This method makes it possible to control how the thumbnail is applied and associated</span>
<span class="sd">        with the item. The default implementation will simply set the thumbnail to be icon</span>
<span class="sd">        of the item, but this can be altered by subclassing this method.</span>

<span class="sd">        :param item: :class:`~PySide.QtGui.QStandardItem` which is associated with the given thumbnail</span>
<span class="sd">        :param field: The Shotgun field which the thumbnail is associated with.</span>
<span class="sd">        :param path: A path on disk to the thumbnail. This is a file in jpeg format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># the default implementation sets the icon</span>
        <span class="n">thumb</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPixmap</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">item</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">thumb</span><span class="p">)</span></div>

<div class="viewcode-block" id="ShotgunModel._populate_thumbnail_image"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel._populate_thumbnail_image">[docs]</a>    <span class="k">def</span> <span class="nf">_populate_thumbnail_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Similar to :meth:`_populate_thumbnail()` but this method is called instead</span>
<span class="sd">        when the bg_load_thumbs parameter has been set to true. In this case, no</span>
<span class="sd">        loading of thumbnail data from disk is necessary - this has already been</span>
<span class="sd">        carried out async and is passed in the form of a QImage object.</span>

<span class="sd">        For further details, see :meth:`_populate_thumbnail()`</span>

<span class="sd">        :param item: :class:`~PySide.QtGui.QStandardItem` which is associated with the given thumbnail</span>
<span class="sd">        :param field: The Shotgun field which the thumbnail is associated with.</span>
<span class="sd">        :param image: QImage object with the thumbnail loaded</span>
<span class="sd">        :param path: A path on disk to the thumbnail. This is a file in jpeg format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># the default implementation sets the icon</span>
        <span class="n">thumb</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPixmap</span><span class="o">.</span><span class="n">fromImage</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">item</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">thumb</span><span class="p">)</span></div>

<div class="viewcode-block" id="ShotgunModel._before_data_processing"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel._before_data_processing">[docs]</a>    <span class="k">def</span> <span class="nf">_before_data_processing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sg_data_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called just after data has been retrieved from Shotgun but before any processing</span>
<span class="sd">        takes place.</span>

<span class="sd">        .. note:: You can subclass this if you want to perform summaries,</span>
<span class="sd">            calculations and other manipulations of the data before it is</span>
<span class="sd">            passed on to the model class. For example, if you request the model</span>
<span class="sd">            to retrieve a list of versions from Shotgun given a Shot,</span>
<span class="sd">            you can then subclass this method to cull out the data so that you</span>
<span class="sd">            are only left with the latest version for each task. This method</span>
<span class="sd">            is often used in conjunction with the order parameter in :meth:`_load_data()`.</span>

<span class="sd">        :param sg_data_list: list of shotgun dictionaries, as retunrned by the find() call.</span>
<span class="sd">        :returns: should return a list of shotgun dictionaries, on the same form as the input.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># default implementation is a passthrough</span>
        <span class="k">return</span> <span class="n">sg_data_list</span></div>

<div class="viewcode-block" id="ShotgunModel._load_external_data"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel._load_external_data">[docs]</a>    <span class="k">def</span> <span class="nf">_load_external_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called whenever the model needs to be rebuilt from scratch. This is called prior</span>
<span class="sd">        to any shotgun data is added to the model.</span>

<span class="sd">        .. note:: You can subclass this to add custom data to the model in a very</span>
<span class="sd">            flexible fashion. If you for example are loading published files from</span>
<span class="sd">            Shotgun, you could use this to load up a listing of files on disk,</span>
<span class="sd">            resulting in a model that shows both published files and local files.</span>
<span class="sd">            External data will not be cached by the ShotgunModel framework.</span>

<span class="sd">        :returns: list of :class:`~PySide.QtGui.QStandardItem`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="ShotgunModel._get_additional_columns"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel._get_additional_columns">[docs]</a>    <span class="k">def</span> <span class="nf">_get_additional_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">primary_item</span><span class="p">,</span> <span class="n">is_leaf</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when an item is about to be inserted into the model, to get additional items</span>
<span class="sd">        to be included in the same row as the specified item. This provides an opportunity</span>
<span class="sd">        for subclasses to create one or more additional columns for each item in the model.</span>

<span class="sd">        Note that this method is always called before inserting an item, even when loading</span>
<span class="sd">        from the cache. Any data that is expensive to compute or query should be added</span>
<span class="sd">        to the ShotgunStandardItem in _populate_item, since column data is not cached.</span>
<span class="sd">        Also note that item population methods (_populate_item, _populate_thumbnail, etc)</span>
<span class="sd">        will not be called on the return columns.</span>

<span class="sd">        This method should return a list of QStandardItems, one for each additional column.</span>
<span class="sd">        The original ShotgunStandardItem is always the first item in each row and should</span>
<span class="sd">        NOT be included in the returned list. Any empty value returned by this method</span>
<span class="sd">        is guaranteed to be treated as an empty list (i.e. you may return None).</span>

<span class="sd">        This method is called after _finalize_item.</span>

<span class="sd">        :param primary_item: :class:`~PySide.QtGui.QStandardItem` that is about to be added to the model</span>
<span class="sd">        :param is_leaf: boolean that is True if the item is a leaf item</span>
<span class="sd">        :param columns: list of Shotgun field names requested as the columns from _load_data</span>

<span class="sd">        :returns: list of :class:`~PySide.QtGui.QStandardItem`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># default implementation will create items for the given fields from the item if it is a leaf</span>
        <span class="c1"># with the display role being the string value for the field and the actual data value in</span>
        <span class="c1"># SG_ASSOCIATED_FIELD_ROLE</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">is_leaf</span> <span class="ow">and</span> <span class="n">columns</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">get_sg_data</span><span class="p">(</span><span class="n">primary_item</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
                <span class="c1"># set the display role to the string representation of the value</span>
                <span class="n">column_item</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QStandardItem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_display_name</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>

                <span class="c1"># set associated field role to be the column value itself</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
                <span class="n">column_item</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">sanitize_for_qt_model</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">SG_ASSOCIATED_FIELD_ROLE</span><span class="p">)</span>

                <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_item</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">items</span></div>

<div class="viewcode-block" id="ShotgunModel._get_additional_column_headers"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel._get_additional_column_headers">[docs]</a>    <span class="k">def</span> <span class="nf">_get_additional_column_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entity_type</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called to set the headers for the additional columns requested from _load_data.</span>

<span class="sd">        :param entity_type: type name of the entity the columns are for</span>
<span class="sd">        :param columns: list of Shotgun field names requested as the columns from _load_data</span>

<span class="sd">        :returns: list of strings to use as the headers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># default implementation will set the headers to the display names for the fields</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_shotgun_globals</span><span class="o">.</span><span class="n">get_field_display_name</span><span class="p">(</span><span class="n">entity_type</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span></div>

    <span class="c1">########################################################################################</span>
    <span class="c1"># private methods</span>

    <span class="k">def</span> <span class="nf">__log_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience wrapper around debug logging</span>

<span class="sd">        :param msg: debug message</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bundle</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span><span class="s2">&quot;[Toolkit SG Model] </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__log_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience wrapper around warning logging</span>

<span class="sd">        :param msg: debug message</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bundle</span><span class="o">.</span><span class="n">log_warning</span><span class="p">(</span><span class="s2">&quot;[Toolkit SG Model] </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__do_depth_first_tree_deletion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Depth first interation and deletion of all child nodes</span>

<span class="sd">        :param node: :class:`~PySide.QtGui.QStandardItem` tree node</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># cleanup children</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()):</span>
            <span class="n">child_node</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__do_depth_first_tree_deletion</span><span class="p">(</span><span class="n">child_node</span><span class="p">)</span>

        <span class="c1"># delete of children</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">rowCount</span><span class="p">())[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">node</span><span class="o">.</span><span class="n">removeRow</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>


<div class="viewcode-block" id="ShotgunModel._on_data_retriever_work_failure"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel._on_data_retriever_work_failure">[docs]</a>    <span class="k">def</span> <span class="nf">_on_data_retriever_work_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asynchronous callback - the data retriever failed to do some work</span>

<span class="sd">        :param uid: The unique id of the work that failed</span>
<span class="sd">        :param msg: The error message returned for the failure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">sanitize_qt</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span> <span class="c1"># qstring on pyqt, str on pyside</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">sanitize_qt</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_work_id</span> <span class="o">!=</span> <span class="n">uid</span><span class="p">:</span>
            <span class="c1"># not our job. ignore</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;Retrieved error from data worker: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__current_work_id</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">full_msg</span> <span class="o">=</span> <span class="s2">&quot;Error retrieving data from Shotgun: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">msg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_refresh_fail</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">full_msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__log_warning</span><span class="p">(</span><span class="n">full_msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="ShotgunModel._on_data_retriever_work_completed"><a class="viewcode-back" href="../../shotgun_model.html#shotgun_model.ShotgunModel._on_data_retriever_work_completed">[docs]</a>    <span class="k">def</span> <span class="nf">_on_data_retriever_work_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">request_type</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Signaled whenever the data retriever completes some work.</span>
<span class="sd">        This method will dispatch the work to different methods</span>
<span class="sd">        depending on what async task has completed.</span>

<span class="sd">        :param uid:             The unique id of the work that completed</span>
<span class="sd">        :param request_type:    Type of work completed</span>
<span class="sd">        :param data:            Result of the work</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">sanitize_qt</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span> <span class="c1"># qstring on pyqt, str on pyside</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">sanitize_qt</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;Received worker payload of type </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">request_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__current_work_id</span> <span class="o">==</span> <span class="n">uid</span><span class="p">:</span>
            <span class="c1"># our publish data has arrived from sg!</span>
            <span class="c1"># process the data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__current_work_id</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">sg_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;sg&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__on_sg_data_arrived</span><span class="p">(</span><span class="n">sg_data</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__thumb_map</span><span class="p">:</span>
            <span class="c1"># a thumbnail is now present on disk!</span>
            <span class="n">thumb_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__thumb_map</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__thumb_map</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span>

            <span class="n">thumbnail_path</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;thumb_path&quot;</span><span class="p">]</span>
            <span class="n">thumbnail</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;image&quot;</span><span class="p">]</span>

            <span class="c1"># if the requested thumbnail has since dissapeared on the server,</span>
            <span class="c1"># path and image will be None. In this case, skip processing</span>
            <span class="k">if</span> <span class="n">thumbnail_path</span><span class="p">:</span>
                <span class="c1"># get the model item from the weakref we stored in the thumb info:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">thumb_info</span><span class="p">[</span><span class="s2">&quot;item_ref&quot;</span><span class="p">]()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="p">:</span>
                    <span class="c1"># the model item no longer exists so we can ignore this result!</span>
                    <span class="k">return</span>
                <span class="n">sg_field</span> <span class="o">=</span> <span class="n">thumb_info</span><span class="p">[</span><span class="s2">&quot;field&quot;</span><span class="p">]</span>

                <span class="c1"># call our deriving class implementation</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__bg_load_thumbs</span><span class="p">:</span>
                    <span class="c1"># worker thread already loaded the thumbnail in as a QImage.</span>
                    <span class="c1"># call a separate method.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_populate_thumbnail_image</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">sg_field</span><span class="p">,</span> <span class="n">thumbnail</span><span class="p">,</span> <span class="n">thumbnail_path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># worker thread only ensured that the image exists</span>
                    <span class="c1"># call method to populate it</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_populate_thumbnail</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">sg_field</span><span class="p">,</span> <span class="n">thumbnail_path</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__on_sg_data_arrived</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sg_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle asynchronous shotgun data arriving after a find request.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;--&gt; Shotgun data arrived. (</span><span class="si">%s</span><span class="s2"> records)&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">sg_data</span><span class="p">))</span>

        <span class="c1"># pre-process data</span>
        <span class="n">sg_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_before_data_processing</span><span class="p">(</span><span class="n">sg_data</span><span class="p">)</span>

        <span class="c1"># QT is struggling to handle the special timezone class that the shotgun API returns.</span>
        <span class="c1"># in fact, on linux it is struggling to serialize any complex object via QDataStream.</span>
        <span class="c1">#</span>
        <span class="c1"># Convert time stamps to unix time. Unix time is a number representing the timestamp</span>
        <span class="c1"># in the number of seconds since 1 Jan 1970 in the UTC timezone. So a unix timestamp</span>
        <span class="c1"># is universal across time zones and DST changes.</span>
        <span class="c1">#</span>
        <span class="c1"># When you are pulling data from the shotgun model and want to convert this unix timestamp</span>
        <span class="c1"># to a *local* timezone object, which is typically what you want when you are</span>
        <span class="c1"># displaying a value on screen, use the following code:</span>
        <span class="c1"># &gt;&gt;&gt; local_datetime = datetime.fromtimestamp(unix_time)</span>
        <span class="c1">#</span>
        <span class="c1"># furthermore, if you want to turn that into a nicely formatted string:</span>
        <span class="c1"># &gt;&gt;&gt; local_datetime.strftime(&#39;%Y-%m-%d %H:%M&#39;)</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sg_data</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sg_data</span><span class="p">[</span><span class="n">idx</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sg_data</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
                    <span class="c1"># convert to unix timestamp, local time zone</span>
                    <span class="n">sg_data</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">sg_data</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">timetuple</span><span class="p">())</span>

        <span class="n">modifications_made</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__entity_tree_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_full_refresh</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sg_data</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># we have an empty tree and incoming sg data.</span>
                <span class="c1"># Run the full recursive tree generation for performance.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_request_full_refresh</span> <span class="o">=</span> <span class="bp">False</span> <span class="c1"># reset flag for next request</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;No cached items in tree! Creating full tree from Shotgun data...&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__rebuild_whole_tree_from_sg_data</span><span class="p">(</span><span class="n">sg_data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;...done!&quot;</span><span class="p">)</span>
                <span class="n">modifications_made</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># no data coming in from shotgun, so no need to rebuild the tree</span>
                <span class="c1"># however still set the modifications flag (we went from an undefined</span>
                <span class="c1"># tree to an empty tree, to trigger a zero-item cache to be saved</span>
                <span class="n">modifications_made</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># go through and see if there are any changes we should apply to the tree.</span>

            <span class="c1"># check if anything has been deleted or added</span>
            <span class="n">ids_from_shotgun</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">sg_data</span> <span class="p">])</span>
            <span class="n">ids_in_tree</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__entity_tree_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

            <span class="n">removed_ids</span> <span class="o">=</span> <span class="n">ids_in_tree</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">ids_from_shotgun</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">removed_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;Detected deleted items </span><span class="si">%s</span><span class="s2">. Rebuilding tree...&quot;</span> <span class="o">%</span> <span class="n">removed_ids</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__rebuild_whole_tree_from_sg_data</span><span class="p">(</span><span class="n">sg_data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;...done!&quot;</span><span class="p">)</span>
                <span class="n">modifications_made</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">added_ids</span> <span class="o">=</span> <span class="n">ids_from_shotgun</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">ids_in_tree</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">added_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># wedge in the new items</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;Detected added items. Adding them in-situ to tree...&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">sg_data</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="n">added_ids</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;Adding </span><span class="si">%s</span><span class="s2"> to tree&quot;</span> <span class="o">%</span> <span class="n">d</span> <span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">__add_sg_item_to_tree</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;...done!&quot;</span><span class="p">)</span>
                    <span class="n">modifications_made</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="c1"># check for modifications. At this point, the number of items in the tree and</span>
            <span class="c1"># the sg data should match, except for any duplicate items in the tree which would</span>
            <span class="c1"># effectively shadow each other. These can be safely ignored.</span>
            <span class="c1">#</span>
            <span class="c1"># Also note that we need to exclude any S3 urls from the comparison as these change</span>
            <span class="c1"># all the time</span>
            <span class="c1">#</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;Checking for modifications...&quot;</span><span class="p">)</span>
            <span class="n">detected_changes</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">sg_data</span><span class="p">:</span>
                <span class="c1"># if there are modifications of any kind, we just rebuild the tree at the moment</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">existing_sg_data</span> <span class="o">=</span> <span class="n">get_sg_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__entity_tree_data</span><span class="p">[</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="p">])</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sg_compare_data</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">existing_sg_data</span><span class="p">):</span>
                        <span class="c1"># shotgun data has changed for this item! Rebuild the tree</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;SG data change: </span><span class="si">%s</span><span class="s2"> --&gt; </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">existing_sg_data</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
                        <span class="n">detected_changes</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__log_warning</span><span class="p">(</span><span class="s2">&quot;Shotgun item </span><span class="si">%s</span><span class="s2"> not appearing in tree - most likely because &quot;</span>
                                          <span class="s2">&quot;there is another object in Shotgun with the same name.&quot;</span> <span class="o">%</span> <span class="n">d</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">detected_changes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;Detected modifications. Rebuilding tree...&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__rebuild_whole_tree_from_sg_data</span><span class="p">(</span><span class="n">sg_data</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;...done!&quot;</span><span class="p">)</span>
                <span class="n">modifications_made</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;...no modifications found.&quot;</span><span class="p">)</span>

        <span class="c1"># last step - save our tree to disk for fast caching next time!</span>
        <span class="k">if</span> <span class="n">modifications_made</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;Saving tree to disk </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__full_cache_path</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__save_to_disk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__full_cache_path</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log_debug</span><span class="p">(</span><span class="s2">&quot;...saving complete!&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log_warning</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t save cache data to disk: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

        <span class="c1"># and emit completion signal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_refreshed</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">modifications_made</span><span class="p">)</span>


    <span class="c1">########################################################################################</span>
    <span class="c1"># shotgun data processing and tree building</span>

    <span class="k">def</span> <span class="nf">__sg_compare_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compares two sg dicts, assumes the same set of keys in both.</span>
<span class="sd">        Omits thumbnail fields because these change all the time (S3).</span>
<span class="sd">        Both inputs are assumed to contain utf-8 encoded data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># handle file attachment data as a special case. If the attachment has been uploaded,</span>
        <span class="c1"># it will contain an amazon url.</span>
        <span class="c1">#</span>
        <span class="c1"># example:</span>
        <span class="c1"># {&#39;name&#39;: &#39;review_2015-05-13_16-53.mov&#39;,</span>
        <span class="c1">#  &#39;url&#39;: &#39;https://....&#39;,</span>
        <span class="c1">#  &#39;content_type&#39;: &#39;video/quicktime&#39;,</span>
        <span class="c1">#  &#39;type&#39;: &#39;Attachment&#39;,</span>
        <span class="c1">#  &#39;id&#39;: 24919,</span>
        <span class="c1">#  &#39;link_type&#39;: &#39;upload&#39;}</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># keep it simple here. if both values are dicts, iterate</span>
            <span class="c1"># over each of the keys and compare them separately</span>
            <span class="c1"># S3 string equality will be automatically handled by</span>
            <span class="c1"># the logic above.</span>
            <span class="k">for</span> <span class="n">a_key</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__sg_compare_data</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a_key</span><span class="p">),</span> <span class="n">b</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a_key</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="bp">False</span>

        <span class="c1"># handle thumbnail fields as a special case</span>
        <span class="c1"># thumbnail urls are (typically, there seem to be several standards!)</span>
        <span class="c1"># on the form:</span>
        <span class="c1"># https://sg-media-usor-01.s3.amazonaws.com/xxx/yyy/filename.ext?lots_of_authentication_headers</span>
        <span class="c1">#</span>
        <span class="c1"># the query string changes all the times, so when we check if an item is out of date, omit it.</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
              <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span>
              <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;amazonaws&quot;</span> <span class="ow">in</span> <span class="n">a</span> <span class="ow">or</span> <span class="s2">&quot;AccessKeyId&quot;</span> <span class="ow">in</span> <span class="n">a</span><span class="p">)):</span>
            <span class="c1"># attempt to parse values are urls and eliminate the querystring</span>
            <span class="c1"># compare hostname + path only</span>
            <span class="n">url_obj_a</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="n">url_obj_b</span> <span class="o">=</span> <span class="n">urlparse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="n">compare_str_a</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url_obj_a</span><span class="o">.</span><span class="n">netloc</span><span class="p">,</span> <span class="n">url_obj_a</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">compare_str_b</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url_obj_b</span><span class="o">.</span><span class="n">netloc</span><span class="p">,</span> <span class="n">url_obj_b</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">compare_str_a</span> <span class="o">!=</span> <span class="n">compare_str_b</span><span class="p">:</span>
                <span class="c1"># url has changed</span>
                <span class="k">return</span> <span class="bp">False</span>

        <span class="k">elif</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">b</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">__add_sg_item_to_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sg_item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a single item to the tree. This is a slow method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">invisibleRootItem</span><span class="p">()</span>
        <span class="c1"># now drill down recursively, create any missing nodes on the way</span>
        <span class="c1"># and eventually add this as a leaf item</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_sg_item_to_tree_r</span><span class="p">(</span><span class="n">sg_item</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hierarchy</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__add_sg_item_to_tree_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sg_item</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">hierarchy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a shotgun item to the tree. Create intermediate nodes if neccessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get the next field to display in tree view</span>
        <span class="n">field</span> <span class="o">=</span> <span class="n">hierarchy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># get lower levels of values</span>
        <span class="n">remaining_fields</span> <span class="o">=</span> <span class="n">hierarchy</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># are we at leaf level or not?</span>
        <span class="n">on_leaf_level</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">remaining_fields</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="c1"># get the item we need at this level. Create it if not found.</span>
        <span class="n">field_display_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_display_name</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">sg_item</span><span class="p">)</span>
        <span class="n">found_item</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">row_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()):</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">row_index</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">on_leaf_level</span><span class="p">:</span>
                <span class="c1"># compare shotgun ids</span>
                <span class="n">sg_data</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SG_DATA_ROLE</span><span class="p">)</span>

                <span class="c1"># #25231 some clients reporting some child items don&#39;t have this data attached</span>
                <span class="c1"># this is either because of a bug which we don&#39;t yet fully understand or beacuse</span>
                <span class="c1"># of model data injected into the tree which does not have this property set</span>
                <span class="c1"># so double check that the data actually is present.</span>
                <span class="k">if</span> <span class="n">sg_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__log_warning</span><span class="p">(</span><span class="s2">&quot;Found cached leaf node in tree with a missing SG_DATA_ROLE. Please report &quot;</span>
                                       <span class="s2">&quot;to support on support@shotgunsoftware.com. If possible, please &quot;</span>
                                       <span class="s2">&quot;make a copy of the file &#39;</span><span class="si">%s</span><span class="s2">&#39; and attach that with the support request. &quot;</span>
                                       <span class="s2">&quot;Affected Node name: &#39;</span><span class="si">%s</span><span class="s2">&#39;. &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__full_cache_path</span><span class="p">,</span> <span class="n">child</span><span class="o">.</span><span class="n">text</span><span class="p">()))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">sg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">sg_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">):</span>
                        <span class="n">found_item</span> <span class="o">=</span> <span class="n">child</span>
                        <span class="k">break</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># not on leaf level. Just compare names</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">text</span><span class="p">())</span> <span class="o">==</span> <span class="n">field_display_name</span><span class="p">:</span>
                    <span class="n">found_item</span> <span class="o">=</span> <span class="n">child</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="n">found_item</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>

            <span class="c1"># didn&#39;t find item! So let&#39;s create it!</span>
            <span class="n">found_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create_item</span><span class="p">(</span><span class="n">field_display_name</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">on_leaf_level</span><span class="p">,</span> <span class="n">sg_item</span><span class="p">)</span>

            <span class="c1"># get a complete row containing all columns for the current item</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_columns</span><span class="p">(</span><span class="n">found_item</span><span class="p">,</span> <span class="n">on_leaf_level</span><span class="p">)</span>

            <span class="c1"># add it to the tree. At this point QT will fire off various signals to inform views etc.</span>
            <span class="n">root</span><span class="o">.</span><span class="n">appendRow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">on_leaf_level</span><span class="p">:</span>
            <span class="c1"># there are more levels that we should recurse down into</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__add_sg_item_to_tree_r</span><span class="p">(</span><span class="n">sg_item</span><span class="p">,</span> <span class="n">found_item</span><span class="p">,</span> <span class="n">remaining_fields</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__process_thumbnail_for_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Schedule a thumb download for an item</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sg_data</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SG_DATA_ROLE</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sg_data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">sg_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

            <span class="k">if</span> <span class="s2">&quot;image&quot;</span> <span class="ow">in</span> <span class="n">field</span> <span class="ow">and</span> <span class="n">sg_data</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c1"># we have a thumb we are supposed to download!</span>
                <span class="c1"># get the thumbnail - store the unique id we get back from</span>
                <span class="c1"># the data retrieve in a dict for fast lookup later</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_request_thumbnail_download</span><span class="p">(</span><span class="n">item</span><span class="p">,</span>
                                                 <span class="n">field</span><span class="p">,</span>
                                                 <span class="n">sg_data</span><span class="p">[</span><span class="n">field</span><span class="p">],</span>
                                                 <span class="n">sg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">),</span>
                                                 <span class="n">sg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__rebuild_whole_tree_from_sg_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the tree and rebuilds it from the given shotgun data.</span>
<span class="sd">        Note that any selection and expansion states in the view will be lost.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># clear all internal memory storage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># get any external payload from deriving classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_external_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__populate_complete_tree</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__create_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_display_name</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">is_leaf</span><span class="p">,</span> <span class="n">sg_item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a model item for the tree.</span>

<span class="sd">        :param field_display_name: Name of the entry in the UI.</span>
<span class="sd">        :param field: Name of the field in the entity dictionary.</span>
<span class="sd">        :param is_leaf: Is this a leaf item?</span>
<span class="sd">        :param sg_item: Entity dictionary.</span>

<span class="sd">        :returns: ShotgunStandardItem instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># construct tree view node object</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">ShotgunStandardItem</span><span class="p">(</span><span class="n">field_display_name</span><span class="p">)</span>

        <span class="c1"># keep tabs of which items we are creating</span>
        <span class="n">item</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">IS_SG_MODEL_ROLE</span><span class="p">)</span>

        <span class="c1"># keep a reference to this object to make GC happy</span>
        <span class="c1"># (pyside may crash otherwise)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__all_tree_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="c1"># store the actual value we have</span>
        <span class="n">item</span><span class="o">.</span><span class="n">setData</span><span class="p">({</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">field</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">sg_item</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="p">},</span> <span class="bp">self</span><span class="o">.</span><span class="n">SG_ASSOCIATED_FIELD_ROLE</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_leaf</span><span class="p">:</span>
            <span class="c1"># this is the leaf level!</span>
            <span class="c1"># attach the shotgun data so that we can access it later</span>
            <span class="c1"># note: QT automatically changes everything to be unicode</span>
            <span class="c1"># according to strange rules of its own, so force convert</span>
            <span class="c1"># all shotgun values to be proper unicode prior to setData</span>
            <span class="n">item</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span><span class="n">sanitize_for_qt_model</span><span class="p">(</span><span class="n">sg_item</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">SG_DATA_ROLE</span><span class="p">)</span>

            <span class="c1"># and also populate the id association in our lookup dict</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__entity_tree_data</span><span class="p">[</span><span class="n">sg_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">item</span>

        <span class="c1"># now we got the object set up. Now start calling custom methods:</span>

        <span class="c1"># set up default thumb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_populate_default_thumbnail</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="c1"># run the populate item method (only runs at construction, not on cache restore)</span>
        <span class="k">if</span> <span class="n">is_leaf</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_populate_item</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">sg_item</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_populate_item</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_tooltip</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">sg_item</span><span class="p">)</span>

        <span class="c1"># run the finalizer (always runs on construction, even via cache)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="c1"># request thumb</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__download_thumbs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__process_thumbnail_for_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">item</span>

    <span class="k">def</span> <span class="nf">__realize_parent_child_hierarchy_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inserts all children nodes alphabetically into their parent, recursively.</span>

<span class="sd">        :param node: Dictionary with keys &#39;item&#39; and &#39;children&#39; representing a ShotgunStandardItem and a list</span>
<span class="sd">            of ShotgunStandardItem to be appended as rows of &#39;item&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If this is a leaf, there are no children.</span>
        <span class="k">if</span> <span class="s2">&quot;children&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">children</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;children&quot;</span><span class="p">]</span>
        <span class="c1"># process values in alphabetical order by name, case insensitive, so that</span>
        <span class="c1"># children are always sorted alphabetically underneath their parent.</span>
        <span class="k">for</span> <span class="n">child_key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">children</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="nb">cmp</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="nb">cmp</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">lower</span><span class="p">())):</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="n">child_key</span><span class="p">]</span>

            <span class="n">on_leaf_level</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;children&quot;</span><span class="p">))</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_columns</span><span class="p">(</span><span class="n">child</span><span class="p">[</span><span class="s2">&quot;item&quot;</span><span class="p">],</span> <span class="n">on_leaf_level</span><span class="p">)</span>
            <span class="n">node</span><span class="p">[</span><span class="s2">&quot;item&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">appendRow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__realize_parent_child_hierarchy_r</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__populate_complete_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sg_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate tree model data structure based on Shotgun data.</span>

<span class="sd">        :param sg_data: List of shotgun entity dictionairies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The tree is built in a two pass approach. We are first building the</span>
        <span class="c1"># individual ShotgunStandardItems and a tree of dictionaries. Each</span>
        <span class="c1"># dictionary has a key named &#39;item&#39; which is the ShotgunStandardItem and</span>
        <span class="c1"># another key named &#39;children&#39; which holds a dictionary of all the direct</span>
        <span class="c1"># children this node has. These children are keyed by their name in the</span>
        <span class="c1"># dictionary. This dictionary of dictionaries approach is recursive from the</span>
        <span class="c1"># root to the leaves. Using a dictionary of children allows us to do a quick</span>
        <span class="c1"># lookup to see if a child node needs to be created or can be reused. We will</span>
        <span class="c1"># be actually parenting the ShotgunStandardItems to other ShotgunStandardItems</span>
        <span class="c1"># in the second pass when we have the complete list of children and can</span>
        <span class="c1"># proceed on sorting them by name before insertion into the parent.</span>
        <span class="c1">#</span>
        <span class="c1"># Note that in the following algorithm two different non-leaf entities with</span>
        <span class="c1"># the same name will be considered to be the same. Only leaf nodes with the</span>
        <span class="c1"># same name are differentiated by appending an id to their name.</span>

        <span class="c1"># and add the shotgun data</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;item&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">invisibleRootItem</span><span class="p">(),</span>
            <span class="s2">&quot;children&quot;</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>

        <span class="c1"># For each item that need to go inside the tree</span>
        <span class="k">for</span> <span class="n">sg_item</span> <span class="ow">in</span> <span class="n">sg_data</span><span class="p">:</span>
            <span class="n">sub_tree</span> <span class="o">=</span> <span class="n">tree</span>

            <span class="c1"># Create model items by drilling down the hierarchy</span>
            <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__hierarchy</span><span class="p">:</span>
                <span class="n">on_leaf_level</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__hierarchy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">field_name</span><span class="p">)</span>
                <span class="c1"># Get the value of field</span>
                <span class="n">field_display_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_display_name</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">sg_item</span><span class="p">)</span>

                <span class="c1"># If we are at the leaf and there is already an item with the same name make</span>
                <span class="c1"># this new item unique.</span>
                <span class="k">if</span> <span class="n">on_leaf_level</span> <span class="ow">and</span> <span class="n">field_display_name</span> <span class="ow">in</span> <span class="n">sub_tree</span><span class="p">[</span><span class="s2">&quot;children&quot;</span><span class="p">]:</span>
                    <span class="n">field_display_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> (id </span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">field_display_name</span><span class="p">,</span> <span class="n">sg_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">))</span>

                <span class="c1"># If this section of the tree has never seen this value</span>
                <span class="k">if</span> <span class="n">field_display_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sub_tree</span><span class="p">[</span><span class="s2">&quot;children&quot;</span><span class="p">]:</span>

                    <span class="c1"># Create the item.</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create_item</span><span class="p">(</span><span class="n">field_display_name</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">on_leaf_level</span><span class="p">,</span> <span class="n">sg_item</span><span class="p">)</span>

                    <span class="n">sub_tree</span><span class="p">[</span><span class="s2">&quot;children&quot;</span><span class="p">][</span><span class="n">field_display_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;item&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">,</span>
                        <span class="s2">&quot;children&quot;</span><span class="p">:</span> <span class="p">{}</span>
                    <span class="p">}</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">on_leaf_level</span><span class="p">:</span>
                    <span class="n">sub_tree</span> <span class="o">=</span> <span class="n">sub_tree</span><span class="p">[</span><span class="s2">&quot;children&quot;</span><span class="p">][</span><span class="n">field_display_name</span><span class="p">]</span>

        <span class="c1"># The second pass here consists of actually adding the children ShotgunStandardItem</span>
        <span class="c1"># inside their parent, all sorted by name.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__realize_parent_child_hierarchy_r</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generate_display_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">sg_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates a name from a shotgun field.</span>
<span class="sd">        For non-nested structures, this is typically just &quot;code&quot;.</span>
<span class="sd">        For nested structures it can either be something like sg_sequence</span>
<span class="sd">        or something like sg_asset_type.</span>

<span class="sd">        :params field: field name to generate name from</span>
<span class="sd">        :params sg_data: sg data dictionary, straight from shotgun, no unicode, all UTF-8</span>
<span class="sd">        :returns: name string</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">sg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">value</span> <span class="ow">and</span> <span class="s2">&quot;type&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;Unnamed&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c1"># this is a list of some sort. Loop over all elements and extrat a comma separated list.</span>
            <span class="n">formatted_values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># no items in list</span>
                <span class="n">formatted_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;No Value&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">v</span> <span class="ow">and</span> <span class="s2">&quot;type&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="c1"># This is a link field</span>
                    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">):</span>
                        <span class="n">formatted_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">formatted_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

            <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted_values</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;Unnamed&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># everything else just cast to string</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__get_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">is_leaf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a row (list of QStandardItems) given an initial QStandardItem.  The item itself</span>
<span class="sd">        is always the first item in the row, but additional columns may be appended.</span>

<span class="sd">        :param item: A :class:`~PySide.QtGui.QStandardItem` that is associated with this model.</span>
<span class="sd">        :param is_leaf: A boolean indicating if the item is a leaf item or not</span>

<span class="sd">        :returns: A list of :class:`~PySide.QtGui.QStandardItem` s</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># the first item in the row is always the standard shotgun model item,</span>
        <span class="c1"># but subclasses may provide additional columns to be appended.</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">]</span>
        <span class="n">row</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_additional_columns</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">is_leaf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__column_fields</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">row</span>

    <span class="c1">########################################################################################</span>
    <span class="c1"># de/serialization of model contents</span>

    <span class="k">def</span> <span class="nf">__save_to_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the model to disk using QDataStream serialization.</span>
<span class="sd">        This all happens on the C++ side and is very fast.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">old_umask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># try to create the cache folder with as open permissions as possible</span>
            <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">,</span> <span class="mo">0777</span><span class="p">)</span>

            <span class="c1"># write cache file</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QFile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QIODevice</span><span class="o">.</span><span class="n">WriteOnly</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">out_stream</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QDataStream</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

                <span class="c1"># write a header</span>
                <span class="n">out_stream</span><span class="o">.</span><span class="n">writeInt64</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FILE_MAGIC_NUMBER</span><span class="p">)</span>
                <span class="n">out_stream</span><span class="o">.</span><span class="n">writeInt32</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FILE_VERSION</span><span class="p">)</span>

                <span class="c1"># todo: if it turns out that there are ongoing issues with</span>
                <span class="c1"># md5 cache collisions, we could write the actual query parameters</span>
                <span class="c1"># to the header of the cache file here and compare that against the</span>
                <span class="c1"># desired query info just to be confident we are getting a correct cache...</span>

                <span class="c1"># tell which serialization dialect to use</span>
                <span class="n">out_stream</span><span class="o">.</span><span class="n">setVersion</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QDataStream</span><span class="o">.</span><span class="n">Qt_4_0</span><span class="p">)</span>

                <span class="n">root</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">invisibleRootItem</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__save_to_disk_r</span><span class="p">(</span><span class="n">out_stream</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="c1"># and ensure the cache file has got open permissions</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="mo">0666</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__log_warning</span><span class="p">(</span><span class="s2">&quot;Could not write cache file &#39;</span><span class="si">%s</span><span class="s2">&#39; to disk: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="n">old_umask</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__save_to_disk_r</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursive tree writer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_rows</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_rows</span><span class="p">):</span>
            <span class="c1"># write this</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">child</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="c1"># only write shotgun data!</span>
            <span class="c1"># data from external sources is never serialized</span>
            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IS_SG_MODEL_ROLE</span><span class="p">):</span>
                <span class="n">child</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
                <span class="n">stream</span><span class="o">.</span><span class="n">writeInt32</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">hasChildren</span><span class="p">():</span>
                <span class="c1"># write children</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__save_to_disk_r</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__load_from_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a serialized model from disk.</span>

<span class="sd">        :returns: Number of items loaded</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">num_items_loaded</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">fh</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QFile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="n">fh</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QIODevice</span><span class="o">.</span><span class="n">ReadOnly</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">in_stream</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QDataStream</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>

            <span class="n">magic</span> <span class="o">=</span> <span class="n">in_stream</span><span class="o">.</span><span class="n">readInt64</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">magic</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILE_MAGIC_NUMBER</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid file magic number!&quot;</span><span class="p">)</span>

            <span class="n">version</span> <span class="o">=</span> <span class="n">in_stream</span><span class="o">.</span><span class="n">readInt32</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">version</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILE_VERSION</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">CacheReadVersionMismatch</span><span class="p">(</span><span class="s2">&quot;Cache file version </span><span class="si">%s</span><span class="s2">, &quot;</span>
                                               <span class="s2">&quot;expected version </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FILE_VERSION</span><span class="p">))</span>

            <span class="c1"># tell which deserialization dialect to use</span>
            <span class="n">in_stream</span><span class="o">.</span><span class="n">setVersion</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QDataStream</span><span class="o">.</span><span class="n">Qt_4_0</span><span class="p">)</span>

            <span class="n">curr_parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">invisibleRootItem</span><span class="p">()</span>
            <span class="n">prev_node</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">curr_depth</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">while</span> <span class="ow">not</span> <span class="n">in_stream</span><span class="o">.</span><span class="n">atEnd</span><span class="p">():</span>
                <span class="c1"># read data</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">ShotgunStandardItem</span><span class="p">()</span>
                <span class="n">num_items_loaded</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># keep a reference to this object to make GC happy</span>
                <span class="c1"># (pyside may crash otherwise)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__all_tree_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">item</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">in_stream</span><span class="p">)</span>
                <span class="n">node_depth</span> <span class="o">=</span> <span class="n">in_stream</span><span class="o">.</span><span class="n">readInt32</span><span class="p">()</span>

                <span class="c1"># all leaf nodes have an sg id stored in their metadata</span>
                <span class="c1"># the role data accessible via item.data() contains the sg id for this item</span>
                <span class="c1"># if there is a sg id associated with this node</span>
                <span class="n">sg_data</span> <span class="o">=</span> <span class="n">get_sg_data</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sg_data</span><span class="p">:</span>
                    <span class="c1"># add the model item to our tree data dict keyed by id</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__entity_tree_data</span><span class="p">[</span> <span class="n">sg_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="n">item</span>

                <span class="c1"># serialized items contain some sort of strange</span>
                <span class="c1"># low-rez thumb data which we cannot use. Make</span>
                <span class="c1"># sure that is all cleared.</span>
                <span class="n">item</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QtGui</span><span class="o">.</span><span class="n">QIcon</span><span class="p">())</span>

                <span class="c1"># serialized items do not contain a full high rez thumb, so</span>
                <span class="c1"># re-create that. First, set the default thumbnail</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_populate_default_thumbnail</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

                <span class="c1"># run the finalize method so that subclasses</span>
                <span class="c1"># can do any setup they need</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_finalize_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">node_depth</span> <span class="o">==</span> <span class="n">curr_depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># this new node is a child of the previous node</span>
                    <span class="n">curr_parent</span> <span class="o">=</span> <span class="n">prev_node</span>
                    <span class="k">if</span> <span class="n">prev_node</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;File integrity issues!&quot;</span><span class="p">)</span>
                    <span class="n">curr_depth</span> <span class="o">=</span> <span class="n">node_depth</span>

                <span class="k">elif</span> <span class="n">node_depth</span> <span class="o">&gt;</span> <span class="n">curr_depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># something&#39;s wrong!</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;File integrity issues!&quot;</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">node_depth</span> <span class="o">&lt;</span> <span class="n">curr_depth</span><span class="p">:</span>
                    <span class="c1"># we are going back up to parent level</span>
                    <span class="k">while</span> <span class="n">curr_depth</span> <span class="o">&gt;</span> <span class="n">node_depth</span><span class="p">:</span>
                        <span class="n">curr_depth</span> <span class="o">=</span> <span class="n">curr_depth</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="n">curr_parent</span> <span class="o">=</span> <span class="n">curr_parent</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">curr_parent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="c1"># we reached the root. special case</span>
                            <span class="n">curr_parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">invisibleRootItem</span><span class="p">()</span>

                <span class="c1"># get a complete row containing all columns for the current item.</span>
                <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_columns</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">sg_data</span><span class="p">))</span>

                <span class="c1"># and attach the node</span>
                <span class="n">curr_parent</span><span class="o">.</span><span class="n">appendRow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

                <span class="c1"># request thumb</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__download_thumbs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__process_thumbnail_for_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

                <span class="n">prev_node</span> <span class="o">=</span> <span class="n">item</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">num_items_loaded</span></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Autodesk.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'v4.2.3',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>